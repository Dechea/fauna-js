var w={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var _={max_conns:10,endpoint:w.cloud,timeout_ms:6e4},O=class{clientConfiguration;#e;headers={};constructor(e){this.clientConfiguration={..._,...e,secret:this.#t(e)},this.headers={Authorization:`Bearer ${this.clientConfiguration.secret}`,"Content-Type":"application/json","X-Format":"simple"},this.#n(this.clientConfiguration,this.headers)}#t(e){let t;typeof process=="object"&&(t=process.env.FAUNA_SECRET);let r=e?.secret||t;if(r===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return r}async query(e,t){return"query"in e?this.#r({...e,...t}):this.#r(e.toQuery(t))}async#r(e){let{query:t,arguments:r}=e;this.#n(e,this.headers);try{let n=await fetch(`${this.clientConfiguration.endpoint.toString()}/query/1`,{method:"POST",headers:this.headers,body:JSON.stringify({query:t,arguments:r}),keepalive:!0}).then(async l=>l.json());if("errors"in n)throw new Error(JSON.stringify(n.errors[0]));if("error"in n)throw new Error(JSON.stringify(n?.error));let o=n?.txn_time,a=new Date(o);return(this.#e===void 0&&o!==void 0||o!==void 0&&this.#e!==void 0&&this.#e<a)&&(this.#e=a),n}catch(n){throw new Error(n)}}#n(e,t){for(let r of Object.entries(e))if(["last_txn","timeout_ms","linearized","max_contention_retries","traceparent","tags"].includes(r[0])){let n,o=`x-${r[0].replaceAll("_","-")}`;r[0]==="tags"?(o="x-fauna-tags",n=Object.entries(r[1]).map(a=>a.join("=")).join(",")):typeof r[1]=="string"?n=r[1]:n=String(r[1]),r[0]==="traceparent"&&(o=r[0]),t[o]=n}t["x-last-txn"]===void 0&&this.#e!==void 0&&(t["x-last-txn"]=this.#e.toISOString())}};var s=class extends Error{httpStatus;code;summary;constructor(e,t){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,s),this.name="ServiceError",this.code=e.error.code,this.httpStatus=t,e.summary&&(this.summary=e.summary)}},d=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,d),this.name="QueryRuntimeError"}},g=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,g),this.name="QueryCheckError"}},m=class extends s{stats;constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,m),this.name="QueryTimeoutError",this.stats=e.stats}},f=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="AuthenticationError"}},h=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="AuthorizationError"}},S=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="ThrottlingError"}},x=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="ServiceInternalError"}},b=class extends s{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="ServiceTimeoutError"}},p=class extends Error{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,p),this.name="ClientError"}},Q=class extends Error{constructor(e,t){super(e,t),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="NetworkError"}},T=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var j=/(?:\d{4}|[\u2212-]\d{4,}|\+\d{5,})/,C=/(?:0[1-9]|1[0-2])/,A=/(?:0[1-9]|[12]\d|3[01])/,I=/(?:[01][0-9]|2[0-3])/,E=/(?:[0-5][0-9])/,J=/(?:\.\d+)/,q=new RegExp(`(${j.source}-(${C.source})-(${A.source}))`),V=new RegExp(`(${I.source}:${E.source}:${E.source}${J.source}?)`),L=new RegExp(`([zZ]|[+\u2212-]${I.source}(?::?${E.source}|:${E.source}:${E.source}))`),N=new RegExp(`^${q.source}$`),$=new RegExp(`^${q.source}`),D=new RegExp(`^${q.source}T${V.source}${L.source}$`);var u=class{isoString;constructor(e){this.isoString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);if(D.exec(e)===null)throw new RangeError(`(regex) Expected an ISO date string but received '${e}'`);return new u(e)}static fromDate(e){return new u(e.toISOString())}toDate(){let e=new Date(this.isoString);if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`TimeStub("${this.isoString}")`}},c=class{dateString;constructor(e){this.dateString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);let t=N.exec(e);if(t===null)throw new RangeError(`Expected a plain date string but received '${e}'`);return new c(t[0])}static fromDate(e){let t=e.toISOString(),r=$.exec(t);if(r===null)throw new p(`Failed to parse date '${e}'`);return new c(r[0])}toDate(){let e=new Date(this.dateString+"T00:00:00Z");if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`DateStub("${this.dateString}")`}};var y=class{static encode(e){return new F(e).result}static decode(e){return JSON.parse(e,(t,r)=>{if(r==null)return null;if(r["@mod"])return r["@mod"];if(r["@doc"]){if(typeof r["@doc"]=="string"){let[n,o]=r["@doc"].split(":");return{coll:n,id:o}}return r["@doc"]}else{if(r["@ref"])return r["@ref"];if(r["@set"])return r["@set"];if(r["@int"])return Number(r["@int"]);if(r["@long"])return BigInt(r["@long"]);if(r["@double"])return Number(r["@double"]);if(r["@date"])return c.from(r["@date"]);if(r["@time"])return u.from(r["@time"]);if(r["@object"])return r["@object"]}return r})}},P=BigInt("-9223372036854775808"),U=BigInt("9223372036854775807"),F=class{result;#e={bigint:e=>{if(e<P||e>U)throw new RangeError("Precision loss when converting BigInt to Fauna type");return{"@long":e.toString()}},number:e=>{if(e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)throw new RangeError(`Cannot convert ${e} to a Fauna type.`);return`${e}`.includes(".")?{"@double":e.toString()}:e>=-(2**31)&&e<=2**31-1?{"@int":e.toString()}:Number.isSafeInteger(e)?{"@long":e.toString()}:{"@double":e.toString()}},string:e=>e,object:e=>{let t=!1,r={};for(let n in e)n.startsWith("@")&&(t=!0),r[n]=y.encode(e[n]);return t?{"@object":r}:r},array:e=>{let t=[];for(let r in e)t.push(y.encode(e[r]));return t},date:e=>({"@time":e.toISOString()}),faunadate:e=>({"@date":e.dateString}),faunatime:e=>({"@time":e.isoString})};constructor(e){switch(this.result=e,typeof e){case"bigint":this.result=this.#e.bigint(e);break;case"string":this.result=this.#e.string(e);break;case"number":this.result=this.#e.number(e);break;case"object":e==null?this.result=null:Array.isArray(e)?this.result=this.#e.array(e):e instanceof Date?this.result=this.#e.date(e):e instanceof c?this.result=this.#e.faunadate(e):e instanceof u?this.result=this.#e.faunatime(e):this.result=this.#e.object(e);break}}};var H=i=>i instanceof Object&&typeof i.toQuery=="function";function M(i,...e){return new k(i,...e)}var k=class{#e;#t;constructor(e,...t){if(e.length===0||e.length!==t.length+1)throw new Error("invalid query constructed");this.#e=e,this.#t=t}toQuery(e={}){return{...this.#r(e),...e}}#r(e){if(this.#e.length===1)return{query:{fql:[this.#e[0]]},arguments:{}};let t={};return{query:{fql:this.#e.flatMap((n,o)=>{if(o===this.#e.length-1)return n===""?[]:[n];let a=this.#t[o],l;if(H(a)){let R=a.toQuery(e);l=R.query,t={...t,...R.arguments}}else l={value:y.encode(a)};return[n,l].filter(R=>R!=="")})},arguments:t}}};export{f as AuthenticationError,h as AuthorizationError,O as Client,p as ClientError,Q as NetworkError,T as ProtocolError,g as QueryCheckError,d as QueryRuntimeError,m as QueryTimeoutError,s as ServiceError,x as ServiceInternalError,b as ServiceTimeoutError,S as ThrottlingError,w as endpoints,M as fql};
//# sourceMappingURL=index.js.map
