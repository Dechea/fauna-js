var k={cloud:new URL("https://db.fauna.com"),preview:new URL("https://db.fauna-preview.com"),local:new URL("http://localhost:8443"),localhost:new URL("http://localhost:8443")};var o=class extends Error{httpStatus;code;summary;constructor(e,r){super(e.error.message),Error.captureStackTrace&&Error.captureStackTrace(this,o),this.name="ServiceError",this.code=e.error.code,this.httpStatus=r,e.summary&&(this.summary=e.summary)}},f=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,f),this.name="QueryRuntimeError"}},h=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,h),this.name="QueryCheckError"}},T=class extends o{stats;constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,T),this.name="QueryTimeoutError",this.stats=e.stats}},b=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,b),this.name="AuthenticationError"}},x=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,x),this.name="AuthorizationError"}},S=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,S),this.name="ThrottlingError"}},Q=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,Q),this.name="ServiceInternalError"}},E=class extends o{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,E),this.name="ServiceTimeoutError"}},p=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,p),this.name="ClientError"}},d=class extends Error{constructor(e,r){super(e,r),Error.captureStackTrace&&Error.captureStackTrace(this,d),this.name="NetworkError"}},y=class extends Error{httpStatus;constructor(e){super(e.message),Error.captureStackTrace&&Error.captureStackTrace(this,y),this.name="ProtocolError",this.httpStatus=e.httpStatus}};var N=n=>n instanceof Object&&"data"in n,I=n=>n instanceof Object&&"error"in n&&n.error instanceof Object&&"code"in n.error&&"message"in n.error;var R=class{async request({data:e,headers:r,method:t,url:s}){let i=await fetch(s,{method:t,headers:{...r,"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(w=>{throw new d("The network connection encountered a problem.",{cause:w})}),a=i.status,c={};i.headers.forEach((w,J)=>c[J]=w);let u=await i.text();return{status:a,body:u,headers:c}}};var _=()=>new R,$=n=>n instanceof Object&&"body"in n&&"headers"in n&&"status"in n;var V=/(?:\d{4}|[\u2212-]\d{4,}|\+\d{5,})/,L=/(?:0[1-9]|1[0-2])/,B=/(?:0[1-9]|[12]\d|3[01])/,H=/(?:[01][0-9]|2[0-3])/,q=/(?:[0-5][0-9])/,U=/(?:\.\d+)/,F=new RegExp(`(${V.source}-(${L.source})-(${B.source}))`),M=new RegExp(`(${H.source}:${q.source}:${q.source}${U.source}?)`),z=new RegExp(`([zZ]|[+\u2212-]${H.source}(?::?${q.source}|:${q.source}:${q.source}))`),D=new RegExp(`^${F.source}$`),A=new RegExp(`^${F.source}`),j=new RegExp(`^${F.source}T${M.source}${z.source}$`);var g=class{isoString;constructor(e){this.isoString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);if(j.exec(e)===null)throw new RangeError(`(regex) Expected an ISO date string but received '${e}'`);return new g(e)}static fromDate(e){return new g(e.toISOString())}toDate(){let e=new Date(this.isoString);if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`TimeStub("${this.isoString}")`}},m=class{dateString;constructor(e){this.dateString=e}static from(e){if(typeof e!="string")throw new TypeError(`Expected string but received ${typeof e}: ${e}`);let r=D.exec(e);if(r===null)throw new RangeError(`Expected a plain date string but received '${e}'`);return new m(r[0])}static fromDate(e){let r=e.toISOString(),t=A.exec(r);if(t===null)throw new p(`Failed to parse date '${e}'`);return new m(t[0])}toDate(){let e=new Date(this.dateString+"T00:00:00Z");if(e.toString()==="Invalid Date")throw new RangeError("Fauna Date could not be converted to Javascript Date");return e}toString(){return`DateStub("${this.dateString}")`}};var l=class{static encode(e){return new C(e).result}static decode(e){return JSON.parse(e,(r,t)=>{if(t==null)return null;if(t["@mod"])return t["@mod"];if(t["@doc"]){if(typeof t["@doc"]=="string"){let[s,i]=t["@doc"].split(":");return{coll:s,id:i}}return t["@doc"]}else{if(t["@ref"])return t["@ref"];if(t["@set"])return t["@set"];if(t["@int"])return Number(t["@int"]);if(t["@long"])return BigInt(t["@long"]);if(t["@double"])return Number(t["@double"]);if(t["@date"])return m.from(t["@date"]);if(t["@time"])return g.from(t["@time"]);if(t["@object"])return t["@object"]}return t})}},G=BigInt("-9223372036854775808"),W=BigInt("9223372036854775807"),C=class{result;#e={bigint:e=>{if(e<G||e>W)throw new RangeError("Precision loss when converting BigInt to Fauna type");return{"@long":e.toString()}},number:e=>{if(e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)throw new RangeError(`Cannot convert ${e} to a Fauna type.`);return`${e}`.includes(".")?{"@double":e.toString()}:e>=-(2**31)&&e<=2**31-1?{"@int":e.toString()}:Number.isSafeInteger(e)?{"@long":e.toString()}:{"@double":e.toString()}},string:e=>e,object:e=>{let r=!1,t={};for(let s in e)s.startsWith("@")&&(r=!0),t[s]=l.encode(e[s]);return r?{"@object":t}:t},array:e=>{let r=[];for(let t in e)r.push(l.encode(e[t]));return r},date:e=>({"@time":e.toISOString()}),faunadate:e=>({"@date":e.dateString}),faunatime:e=>({"@time":e.isoString})};constructor(e){switch(this.result=e,typeof e){case"bigint":this.result=this.#e.bigint(e);break;case"string":this.result=this.#e.string(e);break;case"number":this.result=this.#e.number(e);break;case"object":e==null?this.result=null:Array.isArray(e)?this.result=this.#e.array(e):e instanceof Date?this.result=this.#e.date(e):e instanceof m?this.result=this.#e.faunadate(e):e instanceof g?this.result=this.#e.faunatime(e):this.result=this.#e.object(e);break}}};var Y={endpoint:k.cloud,max_conns:10},O=class{#e;#t;#r;#n;constructor(e,r){this.#e={...Y,...e,secret:this.#i(e)},this.#n=`${this.clientConfiguration.endpoint.toString()}query/1`,r?this.#t=r:this.#t=_()}get lastTxnTs(){return this.#r}set lastTxnTs(e){this.#r=this.#r?Math.max(e,this.#r):e}get clientConfiguration(){let{secret:e,...r}=this.#e;return r}async query(e,r){return"query"in e?this.#o({...e,...r}):this.#o(e.toQuery(r))}#s(e){if(e instanceof p||e instanceof d||e instanceof y||e instanceof o)return e;if($(e)){if(I(e.body)){let r=e.body,t=e.status;return this.#a(r,t)}return new y({message:`Response is in an unkown format: ${e.body}`,httpStatus:e.status})}return new p("A client level error occurred. Fauna was not called.",{cause:e})}#i(e){let r;typeof process=="object"&&(r=process.env.FAUNA_SECRET);let t=e?.secret||r;if(t===void 0)throw new Error("You must provide a secret to the driver. Set it in an environmental variable named FAUNA_SECRET or pass it to the Client constructor.");return t}#a(e,r){switch(r){case 400:return r===400&&Z.includes(e.error.code)?new h(e,r):new f(e,r);case 401:return new b(e,r);case 403:return new x(e,r);case 429:return new S(e,r);case 440:return new T(e,r);case 500:return new Q(e,r);case 503:return new E(e,r);default:return new o(e,r)}}async#o(e){try{let r={Authorization:`Bearer ${this.#e.secret}`,"x-typecheck":"false"};this.#c({...this.clientConfiguration,...e},r);let t=(this.#e.format??"tagged")==="tagged"||e.format==="tagged",s=t?l.encode(e.arguments):e.arguments,i={query:e.query,arguments:s},a=await this.#t.request({url:this.#n,method:"POST",headers:r,data:i}),c;try{c={...a,body:t?l.decode(a.body):JSON.parse(a.body)}}catch(w){throw new y({message:`Error parsing response as JSON: ${w}`,httpStatus:a.status})}if(!N(c.body))throw this.#s(c);let u=c.body.txn_ts;return(this.#r===void 0&&u!==void 0||u!==void 0&&this.#r!==void 0&&this.#r<u)&&(this.#r=u),c.body}catch(r){throw this.#s(r)}}#c(e,r){for(let t of Object.entries(e))if(["format","query_timeout_ms","linearized","max_contention_retries","traceparent","query_tags"].includes(t[0])){let s,i=`x-${t[0].replaceAll("_","-")}`;t[0]==="query_tags"?s=Object.entries(t[1]).map(a=>a.join("=")).join(","):typeof t[1]=="string"?s=t[1]:s=String(t[1]),t[0]==="traceparent"&&(i=t[0]),r[i]=s}r["x-last-txn-ts"]===void 0&&this.#r!==void 0&&(r["x-last-txn-ts"]=this.#r)}},Z=["invalid_function_definition","invalid_identifier","invalid_query","invalid_syntax","invalid_type"];var K=n=>n instanceof Object&&typeof n.toQuery=="function";function X(n,...e){return new P(n,...e)}var P=class{#e;#t;constructor(e,...r){if(e.length===0||e.length!==r.length+1)throw new Error("invalid query constructed");this.#e=e,this.#t=r}toQuery(e={}){return{...this.#r(e),...e}}#r(e){if(this.#e.length===1)return{query:{fql:[this.#e[0]]},arguments:{}};let r={};return{query:{fql:this.#e.flatMap((s,i)=>{if(i===this.#e.length-1)return s===""?[]:[s];let a=this.#t[i],c;if(K(a)){let u=a.toQuery(e);c=u.query,r={...r,...u.arguments}}else c={value:l.encode(a)};return[s,c].filter(u=>u!=="")})},arguments:r}}};export{b as AuthenticationError,x as AuthorizationError,O as Client,p as ClientError,d as NetworkError,y as ProtocolError,h as QueryCheckError,f as QueryRuntimeError,T as QueryTimeoutError,o as ServiceError,Q as ServiceInternalError,E as ServiceTimeoutError,S as ThrottlingError,k as endpoints,X as fql};
//# sourceMappingURL=index.js.map
